version: 2
jobs:
  build:
    machine: true
    steps:
      - checkout
      - run: 
          name: install aws
          command: |
            curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip"
            unzip awscli-bundle.zip
            sudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws
      - run:
          name: build image
          command: "docker build -t myapp ."
      - run:
          name: ecr login
          command: aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 492266378106.dkr.ecr.us-west-2.amazonaws.com/ricardo
      - run:
          command: docker tag myapp $AWS_ECR_ACCOUNT_URL/${MY_APP_PREFIX}:{CIRCLE_SHA1}
      - run:
          command: docker push $AWS_ECR_ACCOUNT_URL/${MY_APP_PREFIX}:{CIRCLE_SHA1}

